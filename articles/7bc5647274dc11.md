---
title: "Nest.jsã§SWCã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰/ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹"
emoji: "ğŸ’ª"
type: "tech"
topics:
  - "nodejs"
  - "nestjs"
  - "swc"
published: true
published_at: "2023-01-13 05:27"
---

# åˆã‚ã«

ã“ã®è¨˜äº‹ã§ã¯build, devã§SWCã‚’ä½¿ã†ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†è¨˜äº‹ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã“ã®è¨˜äº‹ã§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã«pnpmã‚’ç”¨ã„ã¦ã„ã¾ã™ãŒã€npmç­‰ã‚’ã”åˆ©ç”¨ã®å ´åˆã¯pnpmã®æ‰€ã‚’npmã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

## HMRã¨ã¯

**H** Hot
**M** Module
**R** Replacement
ã®ç•¥ã§ã™ã€‚
ä»Šå›ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã‚’æœ¬å½“ã«HMRã¨ã„ã†ã®ã‹ã„ã¾ã„ã¡ç§ã«ã¯ã‚ã‹ã‚Šã‹ã­ã‚‹ã®ã§ã™ãŒã€è¦ã¯ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã‚’åŠ ãˆãŸéš›ã«è‡ªå‹•ã§Nest.jsã‚’å†èµ·å‹•ã—ã¦ãã‚Œã‚‹ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§okã§ã™ã€‚Nest.jsæ¨™æº–ã®devã‚³ãƒãƒ³ãƒ‰ã¯SWCã¨æ¯”ã¹ã‚‹ã¨ã‹ãªã‚Šé…ãã€é »ç¹ã«å¤‰æ›´ã™ã‚‹ã¨çµæ§‹ãªæ™‚é–“ãŒæ›ã‹ã£ã¦ã—ã¾ã†ã®ã§ã€ã“ã®è¨˜äº‹ã§æ‰±ã†å†…å®¹ã§å¿«é©ãªé–‹ç™ºä½“é¨“ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚



## ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã™ã‚‹

```bash
# buildã ã‘ã‚„ã‚‹æ–¹
pnpm add -D @swc/cli @swc/core

# build, devã©ã¡ã‚‰ã‚‚ã‚„ã‚‹æ–¹
pnpm add -D @swc/cli @swc/core @swc/register chokidar
```

## swcã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`.swcrc`ã¨ã„ã†åå‰ã§ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```bash
{
  "jsc": {
    "parser": {
      "syntax": "typescript",
      "decorators": true,
    },
    "target": "es2020",
    "keepClassNames": true,
    "transform": {
      "legacyDecorator": true,
      "decoratorMetadata": true,
    }
  },
  "module": {
    "type": "commonjs",
    "noInterop": true
  }
}
```

## nest-cli.jsonã‚’ç·¨é›†ã™ã‚‹

sourceRootãŒã‚ã‚Œã°å•é¡Œãªã„ã§ã™ãŒã€ä¸€å¿œå…¨ã¦è¼‰ã›ã¦ãŠãã¾ã™ã€‚ï¼ˆãã‚‚ãã‚‚æ™®é€šã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œã£ãŸãªã‚‰æœ€åˆã‹ã‚‰ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒï¼‰

```json
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "plugins": []
  }
}
```

## devã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ä»Šå›ç´¹ä»‹ã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–¹æ³•ã§ã™ã€‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯`MIT`ã§ã™ã€‚ä½œè€…ã®`manuschillerdev`ã•ã‚“ã¨contributorã®çš†ã•ã‚“ã«æ„Ÿè¬ã§ã™ï¼

https://github.com/manuschillerdev/nestjs-swc


### main.tsã‚’ç·¨é›†ã™ã‚‹

ã¾ãšåˆã‚ã«main.tsã§`bootstrap`é–¢æ•°ã‚’exportã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã¾ãŸã€ã‚ã¨ã§ä½œæˆã™ã‚‹ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³å‡ºã™é–¢ä¿‚ä¸Š`bootstrap()`ã¨ã„ã†å‘¼ã³å‡ºã—ã‚’`process.env.NODE_ENV`ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã£ã¦è¡Œã†ã‹ã©ã†ã‹æ±ºã‚ã¾ã™ã€‚
æœ€å¾Œã«é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦`bootstrap`é–¢æ•°ã§`return app`ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã‚ã¨ã§ä½œæˆã™ã‚‹ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†ã§ã€nestã‚’æ­¢ã‚ã‚‹ç‚ºã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚
```ts
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";

export async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);

  return app;
}

if (!process.env.NODE_ENV !== 'development') bootstrap();
```

### hmr.tsã‚’ä½œæˆã™ã‚‹

`src/hmr.ts`ã«ä½œæˆã—ã¾ã™ã€‚
ã“ã“ã§ã¯ã€chokidarã‚’ç”¨ã„ã¦nestãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€å…ˆã»ã©exportã—ãŸ`bootstrap`ã‚’å‘¼ã³å‡ºã—ã€nestã‚’èµ·å‹•ã—ã¾ã™ã€‚ã¾ãŸã€å¤‰æ›´ãŒç™ºç”Ÿã—ãŸå ´åˆã¯è‡ªå‹•ã§`bootstrap`ã®æˆ»ã‚Šå€¤ã§ã‚ã‚‹`app`ã‚’ç”¨ã„ã¦ã€`app.close()`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

importç­‰ã‚’æœ¬å®¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚

```ts
import * as chokidar from 'chokidar';
import { INestApplication, Logger } from '@nestjs/common';
import * as path from 'path';
import * as nestCliConfig from '../nest-cli.json';

const SRC_PATH = path.resolve(nestCliConfig.sourceRoot);
const MAIN_PATH = path.resolve(SRC_PATH, 'main.ts');

class HMR {
  private app: INestApplication;
  private logger = new Logger('HMR');

  constructor() {
    chokidar.watch(`${SRC_PATH}/**/*.ts`).on('change', (path) => {
      this.logger.log(`Detected changes in file: ${path}`);
      this.reload();
    });

    // naive error handling - source maps should work
    process.on('unhandledRejection', (reason) => this.logger.error(reason));
  }

  async reload() {
    this.logger.log('Starting HMR cycle');

    await this.executeAndLogWithDuration('Finished HMR cycle', async () => {
      // delete all require caches for SRC_PATH
      // TODO: check how to handle node_modules
      for (const key in require.cache)
        if (key.includes(SRC_PATH)) delete require.cache[key];

      // get fresh instance of main
      const { bootstrap } = await import(MAIN_PATH);
      // close server if running
      if (this.app) {
        await this.executeAndLogWithDuration('Closed server', this.app.close);
      }

      // reinitialize server
      await this.executeAndLogWithDuration(
        'Started Server',
        async () =>
          (this.app = await bootstrap().catch((err) => console.log(err))),
      );
    });
  }

  async executeAndLogWithDuration(msg: string, cb: () => Promise<any>) {
    const start = performance.now();
    await cb();

    const duration = Number(performance.now() - start).toFixed(0);
    this.logger.log(`${msg} +${duration}ms`);
  }
}

const hmr = new HMR();
hmr.reload();
```

## packages.jsonã®scriptsã‚’æ›´æ–°ã™ã‚‹

```json
{
  "scripts": {
    "build": "pnpm swc src -d dist -D",
    "start:dev": "NODE_ENV='development' node -r @swc/register src/hmr.ts",
  }
}
```

## å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸè¨˜äº‹/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

https://zenn.dev/cohky/articles/use-swc-performance
https://github.com/manuschillerdev/nestjs-swc
